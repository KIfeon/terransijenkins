pipeline {
    agent any

    parameters {
        // This will be populated dynamically by the discovery stage
        choice(
            name: 'LAB_TO_DESTROY', 
            choices: ['SCAN_FOR_LABS'], 
            description: 'Choisir le lab √† d√©truire (sera rempli automatiquement)'
        )
        booleanParam(
            name: 'FORCE_DESTROY', 
            defaultValue: false, 
            description: 'Forcer la destruction m√™me si des ressources persistent'
        )
        booleanParam(
            name: 'DRY_RUN', 
            defaultValue: true, 
            description: 'Mode test - affiche les ressources qui seraient d√©truites sans les supprimer'
        )
    }

    environment {
        TF_DIR = './'
        AWS_DEFAULT_REGION = 'us-east-1'
    }

    stages {
        stage('Discover Existing Labs') {
            steps {
                script {
                    echo "=== RECHERCHE DES LABS EXISTANTS ==="
                    
                    // D√©couvrir les labs via les tags AWS
                    def labsFound = sh(
                        script: '''
                            # Rechercher les VPCs avec les tags Environment
                            aws ec2 describe-vpcs \
                                --filters "Name=tag:Environment,Values=*" \
                                --query 'Vpcs[?contains(Tags[?Key==`Environment`].Value, `lab`)].Tags[?Key==`Environment`].Value' \
                                --output text | tr '\\t' '\\n' | sort -u | grep -v '^$' || echo "AUCUN_LAB_TROUVE"
                        ''',
                        returnStdout: true
                    ).trim()

                    if (labsFound == "AUCUN_LAB_TROUVE" || labsFound == "") {
                        echo "‚ùå Aucun lab trouv√© dans AWS"
                        
                        // Aussi chercher via les cl√©s SSH AWS
                        def sshKeys = sh(
                            script: '''
                                aws ec2 describe-key-pairs \
                                    --query 'KeyPairs[?contains(KeyName, `lab`)].KeyName' \
                                    --output text | tr '\\t' '\\n' | sort -u | grep -v '^$' || echo "AUCUNE_CLE_TROUVEE"
                            ''',
                            returnStdout: true
                        ).trim()

                        if (sshKeys != "AUCUNE_CLE_TROUVEE" && sshKeys != "") {
                            echo "üîë Cl√©s SSH trouv√©es (labs potentiels) : ${sshKeys}"
                            
                            // Extraire les noms d'environnement des cl√©s SSH
                            def labsFromKeys = sh(
                                script: '''
                                    aws ec2 describe-key-pairs \
                                        --query 'KeyPairs[?contains(KeyName, `lab`)].KeyName' \
                                        --output text | tr '\\t' '\\n' | sed 's/-key$//' | sort -u
                                ''',
                                returnStdout: true
                            ).trim()
                            
                            env.DISCOVERED_LABS = labsFromKeys
                        } else {
                            error("‚ùå Aucun lab trouv√© via les VPCs ou les cl√©s SSH")
                        }
                    } else {
                        echo "‚úÖ Labs trouv√©s : ${labsFound}"
                        env.DISCOVERED_LABS = labsFound
                    }

                    // Afficher les d√©tails des labs trouv√©s
                    def labs = env.DISCOVERED_LABS.split('\n')
                    echo "=== LABS D√âCOUVERTS ==="
                    for (lab in labs) {
                        if (lab?.trim()) {
                            echo "üß™ Lab: ${lab}"
                            
                            // Obtenir plus de d√©tails sur chaque lab
                            def labDetails = sh(
                                script: """
                                    echo "--- D√©tails pour ${lab} ---"
                                    
                                    # VPC
                                    vpc_id=\$(aws ec2 describe-vpcs --filters "Name=tag:Environment,Values=${lab}" --query 'Vpcs[0].VpcId' --output text 2>/dev/null || echo "N/A")
                                    echo "VPC ID: \$vpc_id"
                                    
                                    # Instances EC2
                                    instances=\$(aws ec2 describe-instances --filters "Name=tag:Environment,Values=${lab}" "Name=instance-state-name,Values=running,stopped,stopping,pending" --query 'Reservations[].Instances[].InstanceId' --output text 2>/dev/null || echo "Aucune")
                                    echo "Instances: \$instances"
                                    
                                    # Load Balancer
                                    alb=\$(aws elbv2 describe-load-balancers --query "LoadBalancers[?contains(LoadBalancerName, '${lab}')].LoadBalancerName" --output text 2>/dev/null || echo "Aucun")
                                    echo "ALB: \$alb"
                                    
                                    # Cl√© SSH
                                    key=\$(aws ec2 describe-key-pairs --key-names "${lab}-key" --query 'KeyPairs[0].KeyName' --output text 2>/dev/null || echo "Aucune")
                                    echo "Cl√© SSH: \$key"
                                """,
                                returnStdout: true
                            )
                            echo labDetails
                        }
                    }
                }
            }
        }

        stage('Validate Lab Selection') {
            when { 
                expression { 
                    return params.LAB_TO_DESTROY != 'SCAN_FOR_LABS' && params.LAB_TO_DESTROY != null 
                } 
            }
            steps {
                script {
                    echo "=== VALIDATION DU LAB S√âLECTIONN√â ==="
                    echo "Lab √† d√©truire: ${params.LAB_TO_DESTROY}"
                    
                    def selectedLab = params.LAB_TO_DESTROY
                    
                    // V√©rifier que le lab existe r√©ellement
                    def labExists = sh(
                        script: """
                            # V√©rifier via VPC ou cl√© SSH
                            vpc_exists=\$(aws ec2 describe-vpcs --filters "Name=tag:Environment,Values=${selectedLab}" --query 'Vpcs[0].VpcId' --output text 2>/dev/null)
                            key_exists=\$(aws ec2 describe-key-pairs --key-names "${selectedLab}-key" --query 'KeyPairs[0].KeyName' --output text 2>/dev/null)
                            
                            if [ "\$vpc_exists" != "None" ] && [ "\$vpc_exists" != "" ] || [ "\$key_exists" != "None" ] && [ "\$key_exists" != "" ]; then
                                echo "EXISTS"
                            else
                                echo "NOT_EXISTS"
                            fi
                        """,
                        returnStdout: true
                    ).trim()

                    if (labExists != "EXISTS") {
                        error("‚ùå Le lab '${selectedLab}' n'existe pas ou a d√©j√† √©t√© d√©truit")
                    }

                    echo "‚úÖ Lab '${selectedLab}' confirm√© pour destruction"
                    env.VALIDATED_LAB = selectedLab
                }
            }
        }

        stage('Show Destruction Plan') {
            when { 
                expression { 
                    return params.LAB_TO_DESTROY != 'SCAN_FOR_LABS' && env.VALIDATED_LAB != null 
                } 
            }
            steps {
                script {
                    echo "=== PLAN DE DESTRUCTION ==="
                    echo "üéØ Lab cibl√©: ${env.VALIDATED_LAB}"
                    echo "üîÑ Mode: ${params.DRY_RUN ? 'DRY RUN (simulation)' : 'DESTRUCTION R√âELLE'}"
                    echo "üí• Force: ${params.FORCE_DESTROY ? 'Activ√©' : 'D√©sactiv√©'}"
                    
                    def destructionPlan = sh(
                        script: """
                            echo "=== RESSOURCES QUI SERONT D√âTRUITES ==="
                            
                            lab="${env.VALIDATED_LAB}"
                            
                            echo "1. INSTANCES EC2:"
                            aws ec2 describe-instances \\
                                --filters "Name=tag:Environment,Values=\$lab" "Name=instance-state-name,Values=running,stopped,stopping,pending" \\
                                --query 'Reservations[].Instances[].[InstanceId,InstanceType,State.Name,Tags[?Key==\`Name\`].Value|[0]]' \\
                                --output table || echo "   Aucune instance trouv√©e"
                            
                            echo ""
                            echo "2. VPC ET COMPOSANTS:"
                            vpc_id=\$(aws ec2 describe-vpcs --filters "Name=tag:Environment,Values=\$lab" --query 'Vpcs[0].VpcId' --output text 2>/dev/null)
                            if [ "\$vpc_id" != "None" ] && [ "\$vpc_id" != "" ]; then
                                echo "   VPC: \$vpc_id"
                                
                                # Subnets
                                echo "   Subnets:"
                                aws ec2 describe-subnets --filters "Name=vpc-id,Values=\$vpc_id" --query 'Subnets[].SubnetId' --output text | tr '\\t' '\\n' | sed 's/^/     /'
                                
                                # Security Groups
                                echo "   Security Groups:"
                                aws ec2 describe-security-groups --filters "Name=vpc-id,Values=\$vpc_id" "Name=group-name,Values=*\$lab*" --query 'SecurityGroups[].[GroupId,GroupName]' --output text | sed 's/^/     /'
                            fi
                            
                            echo ""
                            echo "3. LOAD BALANCERS:"
                            aws elbv2 describe-load-balancers --query "LoadBalancers[?contains(LoadBalancerName, '\$lab')].[LoadBalancerName,LoadBalancerArn]" --output table || echo "   Aucun ALB trouv√©"
                            
                            echo ""
                            echo "4. CL√âS SSH:"
                            aws ec2 describe-key-pairs --key-names "\$lab-key" --query 'KeyPairs[].[KeyName,KeyFingerprint]' --output table 2>/dev/null || echo "   Aucune cl√© trouv√©e"
                        """,
                        returnStdout: true
                    )
                    
                    echo destructionPlan
                }
            }
        }

        stage('Terraform Destroy') {
            when { 
                expression { 
                    return params.LAB_TO_DESTROY != 'SCAN_FOR_LABS' && 
                           env.VALIDATED_LAB != null && 
                           !params.DRY_RUN 
                } 
            }
            steps {
                dir("${env.TF_DIR}") {
                    script {
                        echo "=== DESTRUCTION TERRAFORM ==="
                        echo "üéØ Destruction du lab: ${env.VALIDATED_LAB}"
                        
                        // Initialiser Terraform
                        sh 'terraform init'
                        
                        try {
                            // Tentative de destruction avec les variables connues
                            // Note: On utilise des valeurs par d√©faut car on ne conna√Æt pas forc√©ment 
                            // les param√®tres exacts utilis√©s lors de la cr√©ation
                            sh """
                                echo "=== Tentative de destruction avec param√®tres par d√©faut ==="
                                terraform destroy -auto-approve \\
                                    -var='env_name=${env.VALIDATED_LAB}' \\
                                    -var='instance_count=1' \\
                                    -var='instance_role=generic' \\
                                    -var='instance_distribution=ubuntu' \\
                                    -var='instance_type=t3.micro' || echo "Premi√®re tentative √©chou√©e"
                            """
                            
                            // V√©rifier si des ressources persistent
                            def remainingResources = sh(
                                script: '''
                                    if terraform show | grep -q "resource"; then
                                        echo "RESOURCES_REMAIN"
                                    else
                                        echo "CLEAN"
                                    fi
                                ''',
                                returnStdout: true
                            ).trim()
                            
                            if (remainingResources == "RESOURCES_REMAIN") {
                                echo "‚ö†Ô∏è Des ressources persistent dans le state Terraform"
                                
                                if (params.FORCE_DESTROY) {
                                    echo "üî® Mode force activ√© - tentative avec diff√©rents param√®tres"
                                    
                                    // Essayer avec diff√©rents param√®tres communs
                                    def paramCombos = [
                                        [role: 'webserver', count: '2', type: 't3.micro', distro: 'ubuntu'],
                                        [role: 'db', count: '1', type: 't3.nano', distro: 'debian'],
                                        [role: 'generic', count: '3', type: 't3.medium', distro: 'amazonlinux']
                                    ]
                                    
                                    for (combo in paramCombos) {
                                        try {
                                            sh """
                                                echo "Tentative avec: role=${combo.role}, count=${combo.count}, type=${combo.type}, distro=${combo.distro}"
                                                terraform destroy -auto-approve \\
                                                    -var='env_name=${env.VALIDATED_LAB}' \\
                                                    -var='instance_count=${combo.count}' \\
                                                    -var='instance_role=${combo.role}' \\
                                                    -var='instance_distribution=${combo.distro}' \\
                                                    -var='instance_type=${combo.type}' || true
                                            """
                                            
                                            // V√©rifier si √ßa a march√©
                                            def checkClean = sh(
                                                script: '''
                                                    if terraform show | grep -q "resource"; then
                                                        echo "STILL_REMAIN"
                                                    else
                                                        echo "NOW_CLEAN"
                                                    fi
                                                ''',
                                                returnStdout: true
                                            ).trim()
                                            
                                            if (checkClean == "NOW_CLEAN") {
                                                echo "‚úÖ Destruction r√©ussie avec ces param√®tres!"
                                                break
                                            }
                                        } catch (Exception e) {
                                            echo "Tentative √©chou√©e: ${e.message}"
                                        }
                                    }
                                } else {
                                    error("‚ùå Des ressources persistent. Utilisez FORCE_DESTROY=true pour forcer la suppression.")
                                }
                            }
                            
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Erreur Terraform: ${e.message}"
                            
                            if (params.FORCE_DESTROY) {
                                echo "üî® Mode force - continuation avec nettoyage AWS direct"
                            } else {
                                error("√âchec de la destruction Terraform. Utilisez FORCE_DESTROY pour continuer.")
                            }
                        }
                    }
                }
            }
        }

        stage('AWS Direct Cleanup') {
            when { 
                expression { 
                    return params.LAB_TO_DESTROY != 'SCAN_FOR_LABS' && 
                           env.VALIDATED_LAB != null && 
                           !params.DRY_RUN &&
                           params.FORCE_DESTROY
                } 
            }
            steps {
                script {
                    echo "=== NETTOYAGE DIRECT AWS ==="
                    echo "üßπ Suppression directe des ressources AWS pour: ${env.VALIDATED_LAB}"
                    
                    sh """
                        lab="${env.VALIDATED_LAB}"
                        
                        echo "1. Suppression des instances EC2..."
                        instance_ids=\$(aws ec2 describe-instances \\
                            --filters "Name=tag:Environment,Values=\$lab" "Name=instance-state-name,Values=running,stopped,stopping,pending" \\
                            --query 'Reservations[].Instances[].InstanceId' --output text)
                        
                        if [ "\$instance_ids" != "" ]; then
                            echo "Arr√™t des instances: \$instance_ids"
                            aws ec2 terminate-instances --instance-ids \$instance_ids || true
                            echo "Attente de l'arr√™t des instances..."
                            aws ec2 wait instance-terminated --instance-ids \$instance_ids || true
                        fi
                        
                        echo "2. Suppression des Load Balancers..."
                        alb_arns=\$(aws elbv2 describe-load-balancers --query "LoadBalancers[?contains(LoadBalancerName, '\$lab')].LoadBalancerArn" --output text)
                        for alb_arn in \$alb_arns; do
                            if [ "\$alb_arn" != "" ]; then
                                echo "Suppression ALB: \$alb_arn"
                                aws elbv2 delete-load-balancer --load-balancer-arn \$alb_arn || true
                            fi
                        done
                        
                        echo "3. Suppression des Target Groups..."
                        tg_arns=\$(aws elbv2 describe-target-groups --query "TargetGroups[?contains(TargetGroupName, '\$lab')].TargetGroupArn" --output text)
                        for tg_arn in \$tg_arns; do
                            if [ "\$tg_arn" != "" ]; then
                                echo "Suppression TG: \$tg_arn"
                                aws elbv2 delete-target-group --target-group-arn \$tg_arn || true
                            fi
                        done
                        
                        echo "4. Suppression des Security Groups..."
                        vpc_id=\$(aws ec2 describe-vpcs --filters "Name=tag:Environment,Values=\$lab" --query 'Vpcs[0].VpcId' --output text)
                        if [ "\$vpc_id" != "None" ] && [ "\$vpc_id" != "" ]; then
                            sg_ids=\$(aws ec2 describe-security-groups --filters "Name=vpc-id,Values=\$vpc_id" "Name=group-name,Values=*\$lab*" --query 'SecurityGroups[].GroupId' --output text)
                            for sg_id in \$sg_ids; do
                                if [ "\$sg_id" != "" ]; then
                                    echo "Suppression SG: \$sg_id"
                                    aws ec2 delete-security-group --group-id \$sg_id || true
                                fi
                            done
                        fi
                        
                        echo "5. Suppression de la cl√© SSH..."
                        aws ec2 delete-key-pair --key-name "\$lab-key" || true
                        
                        echo "6. Suppression du VPC (apr√®s un d√©lai)..."
                        sleep 30
                        if [ "\$vpc_id" != "None" ] && [ "\$vpc_id" != "" ]; then
                            # Supprimer les subnets
                            subnet_ids=\$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=\$vpc_id" --query 'Subnets[].SubnetId' --output text)
                            for subnet_id in \$subnet_ids; do
                                echo "Suppression subnet: \$subnet_id"
                                aws ec2 delete-subnet --subnet-id \$subnet_id || true
                            done
                            
                            # Supprimer les route tables (sauf la default)
                            rt_ids=\$(aws ec2 describe-route-tables --filters "Name=vpc-id,Values=\$vpc_id" --query 'RouteTables[?Associations[0].Main!=`true`].RouteTableId' --output text)
                            for rt_id in \$rt_ids; do
                                echo "Suppression route table: \$rt_id"
                                aws ec2 delete-route-table --route-table-id \$rt_id || true
                            done
                            
                            # Supprimer les internet gateways
                            igw_ids=\$(aws ec2 describe-internet-gateways --filters "Name=attachment.vpc-id,Values=\$vpc_id" --query 'InternetGateways[].InternetGatewayId' --output text)
                            for igw_id in \$igw_ids; do
                                echo "D√©tachement et suppression IGW: \$igw_id"
                                aws ec2 detach-internet-gateway --internet-gateway-id \$igw_id --vpc-id \$vpc_id || true
                                aws ec2 delete-internet-gateway --internet-gateway-id \$igw_id || true
                            done
                            
                            # Enfin, supprimer le VPC
                            echo "Suppression VPC: \$vpc_id"
                            aws ec2 delete-vpc --vpc-id \$vpc_id || true
                        fi
                        
                        echo "‚úÖ Nettoyage AWS termin√©"
                    """
                }
            }
        }

        stage('Verify Complete Destruction') {
            when { 
                expression { 
                    return params.LAB_TO_DESTROY != 'SCAN_FOR_LABS' && 
                           env.VALIDATED_LAB != null && 
                           !params.DRY_RUN 
                } 
            }
            steps {
                script {
                    echo "=== V√âRIFICATION DE LA DESTRUCTION COMPL√àTE ==="
                    
                    def verificationResult = sh(
                        script: """
                            lab="${env.VALIDATED_LAB}"
                            
                            echo "V√©rification des ressources restantes pour: \$lab"
                            
                            # V√©rifier les instances
                            remaining_instances=\$(aws ec2 describe-instances \\
                                --filters "Name=tag:Environment,Values=\$lab" "Name=instance-state-name,Values=running,stopped,stopping,pending" \\
                                --query 'Reservations[].Instances[].InstanceId' --output text)
                            
                            # V√©rifier le VPC
                            remaining_vpc=\$(aws ec2 describe-vpcs --filters "Name=tag:Environment,Values=\$lab" --query 'Vpcs[0].VpcId' --output text 2>/dev/null)
                            
                            # V√©rifier les cl√©s SSH
                            remaining_key=\$(aws ec2 describe-key-pairs --key-names "\$lab-key" --query 'KeyPairs[0].KeyName' --output text 2>/dev/null)
                            
                            # V√©rifier les ALB
                            remaining_alb=\$(aws elbv2 describe-load-balancers --query "LoadBalancers[?contains(LoadBalancerName, '\$lab')].LoadBalancerName" --output text 2>/dev/null)
                            
                            if [ "\$remaining_instances" = "" ] && [ "\$remaining_vpc" = "None" ] && [ "\$remaining_key" = "None" ] && [ "\$remaining_alb" = "" ]; then
                                echo "SUCCESS: Toutes les ressources ont √©t√© supprim√©es"
                            else
                                echo "WARNING: Des ressources persistent encore:"
                                [ "\$remaining_instances" != "" ] && echo "  - Instances: \$remaining_instances"
                                [ "\$remaining_vpc" != "None" ] && [ "\$remaining_vpc" != "" ] && echo "  - VPC: \$remaining_vpc"
                                [ "\$remaining_key" != "None" ] && [ "\$remaining_key" != "" ] && echo "  - Cl√© SSH: \$remaining_key"
                                [ "\$remaining_alb" != "" ] && echo "  - ALB: \$remaining_alb"
                            fi
                        """,
                        returnStdout: true
                    )
                    
                    echo verificationResult
                }
            }
        }
    }

    post {
        always {
            script {
                echo "========== R√âSUM√â DE L'OP√âRATION =========="
                
                if (params.LAB_TO_DESTROY == 'SCAN_FOR_LABS') {
                    echo "üîç SCAN TERMIN√â"
                    echo "Labs d√©couverts: ${env.DISCOVERED_LABS ?: 'Aucun'}"
                    echo ""
                    echo "üí° PROCHAINES √âTAPES:"
                    echo "1. Relancez ce pipeline"
                    echo "2. S√©lectionnez le lab √† d√©truire dans la liste d√©roulante"
                    echo "3. Choisissez DRY_RUN=false pour une destruction r√©elle"
                } else if (env.VALIDATED_LAB) {
                    echo "üéØ Lab cibl√©: ${env.VALIDATED_LAB}"
                    echo "üîÑ Mode: ${params.DRY_RUN ? 'SIMULATION (DRY RUN)' : 'DESTRUCTION R√âELLE'}"
                    echo "üí• Force: ${params.FORCE_DESTROY ? 'Activ√©' : 'D√©sactiv√©'}"
                    
                    if (params.DRY_RUN) {
                        echo ""
                        echo "‚ÑπÔ∏è SIMULATION TERMIN√âE - Aucune ressource n'a √©t√© supprim√©e"
                        echo "Pour une destruction r√©elle, relancez avec DRY_RUN=false"
                    }
                }
            }
        }
        success {
            script {
                if (!params.DRY_RUN && env.VALIDATED_LAB) {
                    echo "‚úÖ DESTRUCTION R√âUSSIE pour le lab '${env.VALIDATED_LAB}'"
                } else if (params.DRY_RUN && env.VALIDATED_LAB) {
                    echo "‚úÖ SIMULATION R√âUSSIE pour le lab '${env.VALIDATED_LAB}'"
                } else {
                    echo "‚úÖ SCAN DES LABS TERMIN√â"
                }
            }
        }
        failure {
            script {
                if (env.VALIDATED_LAB) {
                    echo "‚ùå √âCHEC DE LA DESTRUCTION pour le lab '${env.VALIDATED_LAB}'"
                    echo "V√©rifiez manuellement l'√©tat des ressources AWS"
                    echo "Utilisez FORCE_DESTROY=true si n√©cessaire"
                } else {
                    echo "‚ùå √âCHEC DU SCAN DES LABS"
                }
            }
        }
    }
}
